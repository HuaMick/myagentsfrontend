# ==============================================================================
# Cloud Build - MyAgentsFrontend Main Branch Build
# ==============================================================================
# Comprehensive build for main branch commits
# Runs: Lint + All tests + Coverage + Web build
# Trigger: Push to main branch
# Machine: E2_HIGHCPU_8 for faster builds
# ==============================================================================

steps:
  # ==============================================================================
  # 0. Ensure coverage bucket exists
  # ==============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Ensuring coverage bucket exists ==="
        gcloud storage buckets create gs://$PROJECT_ID-coverage --project=$PROJECT_ID 2>/dev/null || true
    id: 'setup'

  # ==============================================================================
  # 1. Build Docker Image
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building Flutter test image ==="
        docker pull gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest || true

        # Build with commit SHA tag for traceability
        if [ -n "$COMMIT_SHA" ]; then
          docker build \
            -t gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest \
            -t gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$COMMIT_SHA \
            --cache-from gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest \
            -f Dockerfile.test \
            .
        else
          docker build \
            -t gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest \
            --cache-from gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest \
            -f Dockerfile.test \
            .
        fi
    id: 'build-image'
    waitFor: ['setup']

  # ==============================================================================
  # 1.5 Push Docker Image
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest']
    id: 'push-image'
    waitFor: ['build-image']

  # ==============================================================================
  # 2. Lint (flutter analyze - fail fast gate)
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Running Flutter Analyze ==="
        docker run --rm gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest \
          flutter analyze --no-fatal-infos --no-fatal-warnings
    id: 'lint'
    waitFor: ['build-image']

  # ==============================================================================
  # 3. Unit Tests with Coverage
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Running Flutter Tests with Coverage ==="
        mkdir -p /workspace/test_results

        # Run container in background to copy coverage files out
        CONTAINER_ID=$(docker run -d gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest sleep infinity)

        # Run tests with coverage
        docker exec $${CONTAINER_ID} flutter test --coverage --reporter expanded
        TEST_EXIT=$?

        # Copy coverage report out
        echo "=== Extracting coverage report ==="
        docker cp $${CONTAINER_ID}:/app/coverage/lcov.info /workspace/test_results/lcov.info || true

        # Cleanup
        docker stop $${CONTAINER_ID} > /dev/null
        docker rm $${CONTAINER_ID} > /dev/null

        exit $${TEST_EXIT}
    id: 'unit-tests'
    waitFor: ['lint']

  # ==============================================================================
  # 4. Build Web Application
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Building Flutter Web Application ==="
        mkdir -p /workspace/web_build

        # Run container to build web
        CONTAINER_ID=$(docker run -d gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest sleep infinity)

        # Build web with release mode
        docker exec $${CONTAINER_ID} flutter build web --release

        # Copy build output
        echo "=== Extracting web build ==="
        docker cp $${CONTAINER_ID}:/app/build/web /workspace/web_build/ || true

        # Cleanup
        docker stop $${CONTAINER_ID} > /dev/null
        docker rm $${CONTAINER_ID} > /dev/null

        # Verify build
        echo "=== Web build contents ==="
        ls -la /workspace/web_build/web/ || echo "Web build may have failed"
    id: 'build-web'
    waitFor: ['unit-tests']

  # ==============================================================================
  # 5. Upload Artifacts to GCS
  # ==============================================================================
  - name: 'gcr.io/cloud-builders/gsutil'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=== Uploading artifacts to GCS ==="

        # Upload coverage report
        if [ -f /workspace/test_results/lcov.info ]; then
          gsutil cp /workspace/test_results/lcov.info gs://$PROJECT_ID-coverage/frontend/$BUILD_ID/lcov.info
          echo "Coverage uploaded to gs://$PROJECT_ID-coverage/frontend/$BUILD_ID/"
        fi

        # Upload web build (if exists)
        if [ -d /workspace/web_build/web ]; then
          gsutil -m cp -r /workspace/web_build/web gs://$PROJECT_ID-coverage/frontend/$BUILD_ID/web-build/
          echo "Web build uploaded to gs://$PROJECT_ID-coverage/frontend/$BUILD_ID/web-build/"
        fi

        # List uploaded artifacts
        echo "=== Artifacts in GCS ==="
        gsutil ls gs://$PROJECT_ID-coverage/frontend/$BUILD_ID/ || true
    id: 'upload-artifacts'
    waitFor: ['build-web']

substitutions:
  _IMAGE_NAME: 'myagentsfrontend-test'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: E2_HIGHCPU_8

artifacts:
  objects:
    location: 'gs://$PROJECT_ID-coverage/frontend/$BUILD_ID'
    paths:
      - '/workspace/test_results/*'
